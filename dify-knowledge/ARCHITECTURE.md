# Dify External Knowledge API 架构说明

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Dify Platform                            │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Dify Application                         │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │ │
│  │  │   Chatbot    │  │   Workflow   │  │     Agent    │     │ │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘     │ │
│  └─────────┼──────────────────┼──────────────────┼────────────┘ │
│            │                  │                  │               │
│  ┌─────────▼──────────────────▼──────────────────▼────────────┐ │
│  │              External Knowledge Module                      │ │
│  │                                                              │ │
│  │  [配置: API Endpoint, API Key, Knowledge ID]                │ │
│  └──────────────────────────┬───────────────────────────────────┘ │
└─────────────────────────────┼─────────────────────────────────────┘
                              │
                              │ HTTP POST /retrieval
                              │ Authorization: Bearer <api-key>
                              │
┌─────────────────────────────▼─────────────────────────────────────┐
│                  Dify External Knowledge API                       │
│                     (FastAPI Application)                          │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │                      API Layer                                │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐             │ │
│  │  │ /retrieval │  │  /health   │  │   Auth     │             │ │
│  │  └─────┬──────┘  └────────────┘  └─────┬──────┘             │ │
│  └────────┼───────────────────────────────┼────────────────────┘ │
│           │                               │                       │
│  ┌────────▼───────────────────────────────▼────────────────────┐ │
│  │                   RAG Service Layer                          │ │
│  │  ┌──────────────────────────────────────────────────────┐   │ │
│  │  │              RAGService                              │   │ │
│  │  │  - 初始化管理                                        │   │ │
│  │  │  - 知识库映射                                        │   │ │
│  │  │  - 元数据过滤                                        │   │ │
│  │  │  - 结果转换                                          │   │ │
│  │  └───────────────────────┬──────────────────────────────┘   │ │
│  └──────────────────────────┼───────────────────────────────────┘ │
│                             │                                     │
│  ┌──────────────────────────▼───────────────────────────────────┐ │
│  │                    RAGAnything Core                           │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │              Document Processing                        │  │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │  │ │
│  │  │  │  Mineru  │  │ Docling  │  │  Parser  │             │  │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘             │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │           Multimodal Processors                         │  │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐             │  │ │
│  │  │  │  Image   │  │  Table   │  │ Equation │             │  │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘             │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  │  ┌────────────────────────────────────────────────────────┐  │ │
│  │  │                   LightRAG                              │  │ │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐       │  │ │
│  │  │  │   Graph    │  │   Vector   │  │    KV      │       │  │ │
│  │  │  │  Storage   │  │  Storage   │  │  Storage   │       │  │ │
│  │  │  └────────────┘  └────────────┘  └────────────┘       │  │ │
│  │  └────────────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │
┌─────────────────────────────▼─────────────────────────────────────┐
│                        External Services                           │
│  ┌──────────────────┐  ┌──────────────────┐  ┌─────────────────┐ │
│  │   LLM Service    │  │ Embedding Service │  │  Vision Service │ │
│  │  (OpenAI/Local)  │  │   (OpenAI/Local)  │  │   (GPT-4V/...)  │ │
│  └──────────────────┘  └──────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流程

### 1. 文档导入流程

```
用户文档
    │
    ├─→ 文档解析 (Mineru/Docling)
    │   ├─→ 文本提取
    │   ├─→ 图像提取
    │   ├─→ 表格提取
    │   └─→ 公式提取
    │
    ├─→ 多模态处理
    │   ├─→ ImageProcessor (图像理解)
    │   ├─→ TableProcessor (表格分析)
    │   └─→ EquationProcessor (公式解析)
    │
    ├─→ 文本分块
    │   └─→ Chunking & Embedding
    │
    └─→ LightRAG 存储
        ├─→ 知识图谱构建
        ├─→ 向量索引
        └─→ 键值存储
```

### 2. 检索查询流程

```
Dify 查询请求
    │
    ├─→ API 认证
    │   └─→ Bearer Token 验证
    │
    ├─→ 参数解析
    │   ├─→ knowledge_id
    │   ├─→ query
    │   ├─→ top_k
    │   ├─→ score_threshold
    │   └─→ metadata_condition
    │
    ├─→ RAGService 处理
    │   ├─→ 知识库定位
    │   ├─→ RAGAnything 查询
    │   │   ├─→ LightRAG 混合检索
    │   │   │   ├─→ 向量检索
    │   │   │   ├─→ 图谱检索
    │   │   │   └─→ 全文检索
    │   │   └─→ 结果排序
    │   └─→ 元数据过滤
    │
    └─→ 响应格式化
        └─→ Dify 标准格式
            ├─→ content
            ├─→ score
            ├─→ title
            └─→ metadata
```

## 核心组件说明

### 1. app.py - FastAPI 应用主体
- 定义 API 端点
- 管理应用生命周期
- 处理认证和错误
- 路由请求到 RAGService

### 2. rag_service.py - RAG 服务封装
- 初始化 RAGAnything
- 管理知识库映射
- 执行检索逻辑
- 应用元数据过滤
- 格式化响应

### 3. models.py - 数据模型
- 请求模型（符合 Dify 规范）
- 响应模型
- 元数据过滤模型
- 错误响应模型

### 4. config.py - 配置管理
- 环境变量加载
- 服务配置
- RAG 配置
- 模型配置

## 关键特性

### 1. API 认证
- Bearer Token 认证
- 支持多个 API 密钥
- 自定义验证逻辑

### 2. 元数据过滤
支持的操作符：
- contains / not contains
- start with / end with
- is / is not
- empty / not empty
- 比较操作符 (=, ≠, >, <, ≥, ≤)
- 时间操作符 (before, after)

逻辑运算符：
- AND：所有条件必须满足
- OR：任一条件满足即可

### 3. 灵活的检索参数
- `top_k`: 控制返回结果数量
- `score_threshold`: 相关性分数阈值
- `metadata_condition`: 复杂的元数据过滤

### 4. 多知识库支持
- 通过 `knowledge_id` 区分不同知识库
- 支持不同的 `working_dir` 映射
- 可扩展的知识库管理

## 部署选项

### 开发环境
```bash
python app.py
```

### 生产环境 - Docker
```bash
docker-compose up -d
```

### 生产环境 - Systemd
创建 systemd 服务文件实现开机自启和进程管理

## 扩展性

### 添加新的知识库
编辑 `rag_service.py` 的 `_load_knowledge_bases` 方法：

```python
def _load_knowledge_bases(self):
    self.knowledge_bases = {
        "kb1": "./rag_storage/kb1",
        "kb2": "./rag_storage/kb2",
        "kb3": "./rag_storage/kb3",
    }
```

### 自定义处理器
可以继承 `ModalProcessor` 添加自定义的多模态处理器

### 集成其他向量数据库
RAGAnything 支持多种向量存储后端，可以通过配置切换

## 性能优化

1. **缓存策略**: 实现查询结果缓存
2. **批处理**: 支持批量查询
3. **异步处理**: 已使用 asyncio
4. **连接池**: 数据库连接池管理
5. **负载均衡**: 多实例部署

## 安全考虑

1. **API 密钥管理**: 使用环境变量，不要硬编码
2. **HTTPS**: 生产环境使用 HTTPS
3. **速率限制**: 添加 API 速率限制
4. **输入验证**: Pydantic 模型验证
5. **日志审计**: 记录所有 API 调用

## 监控和日志

- 健康检查端点: `/health`
- 结构化日志输出
- 错误跟踪和报告
- 性能指标收集（可扩展）
